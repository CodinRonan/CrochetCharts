#!/usr/bin/python
#
#This script will code sign the libraries and application
#so it can be included in the Mac App Store.
#

import datetime
import time
import os
import sys
import getopt

########## Configuration Info ##################

app_name = "Crochet Charts"
app = app_name + ".app"
app_exe = "/Contents/MacOS/Crochet Charts"

bundle_id="com.stitchworkssoftware.Crochet Charts"

fileList = [ "/Contents/Frameworks/QtCore.framework/Versions/4/QtCore",
            "/Contents/Frameworks/QtGui.framework/Versions/4/QtGui",
            "/Contents/Frameworks/QtNetwork.framework/Versions/4/QtNetwork",
            "/Contents/Plugins/accessible/libqtaccessiblewidgets.dylib",
            "/Contents/Plugins/bearer/libqgenericbearer.dylib",
            "/Contents/Plugins/codecs/libqcncodecs.dylib",
            "/Contents/Plugins/codecs/libqjpcodecs.dylib",
            "/Contents/Plugins/codecs/libqkrcodecs.dylib",
            "/Contents/Plugins/codecs/libqtwcodecs.dylib",
            "/Contents/Plugins/imageformats/libqgif.dylib",
            "/Contents/Plugins/imageformats/libqico.dylib",
            "/Contents/Plugins/imageformats/libqjpeg.dylib",
            "/Contents/Plugins/imageformats/libqmng.dylib",
            "/Contents/Plugins/imageformats/libqtiff.dylib"
	    ]

app_store_cert = "3rd Party Mac Developer Application: Brian Milco"
app_store_installer = "3rd Party Mac Developer Installer: Brian Milco"

devel_cert = "Developer ID Application: Brian Milco"
devel_installer = "Developer ID Installer: Brian Milco"

codeSign = "/usr/bin/codesign"
dsymutil = "/usr/bin/dsymutil"
productbuild = "/usr/bin/productbuild"

################################################

opts, args = getopt.getopt(sys.argv[1:], "af:")

certName = devel_cert
certInstaller = devel_installer
appDir = "./"
forAppStore = False

for o, a in opts:
    if o == "-f":
        appDir = a
    elif o == "-a":
        forAppStore = True

if forAppStore:
    print "-- Signing for the App Store --"
    certName = app_store_cert
    certInstaller = app_store_installer
    bundle_id = "com.stitchworkssoftware.CrochetCharts"
else:
    print "-- Signing for the Website --"

#print "Generate symbols: ",
#os.system(dsymutil + " \"" + appDir + "/" + app + app_exe + "\"")
#print "Done"

print "Sign application files: ",
for file in fileList:
    os.system(codeSign + " -f -s \"" + certName + "\" -i \"" + bundle_id + "\" \"" + appDir + "/" + app + file + "\"")
print "Done"

print "Sign Bundle: ",
os.system(codeSign + " -f -s \"" + certName + "\" \"" + appDir + "/" + app + "\"")
print "Done"

if forAppStore:
    print "Package for the App Store: ",
    os.system(productbuild + " --component \"" + appDir + "/" + app + "\" /Applications --sign \"" + certInstaller + "\" --product \"" + appDir + "/" + app + "/Contents/Info.plist\" \"" + app_name + ".pkg\"")
    print "Done"

