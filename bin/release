#!/bin/bash
#
# This script builds a release version of
# the software for each supported platform.
#############################################

function display_vairiables {
    echo "-------------------------------------------------------"
    echo ""
    echo "NOTE: Java must be installed or fop will fail and the pdf will not build."
    echo ""
    echo "Building: $PROJECT_DIR"
    echo ""
    echo "Using the following tools:"
    echo "-- CMake:       $CMAKE"
    echo "-- QMake:       $QMAKE"
    echo "-- CC:          $CC"
    echo "-- CXX:         $CXX"
    echo "-- Platform:    $PLATFORM"
    echo "-- Arch:        $ARCH"
    if [ $PLATFORM == "Darwin" ]; then
        echo "-- App Store:   $APP_STORE"
        echo "-- Bundle ID:   $BUNDLE_ID"
    fi
    echo "-- CMake Flags: $CMAKE_FLAGS"
    echo "-- CPack Flags: $CPACK_FLAGS"
    echo "-------------------------------------------------------"
}

PROJECT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"

APP_STORE="OFF"
DOCS="OFF"
USE_LLVM=true

while getopts ":ad" opt; do
  case $opt in
    a)
      #-a is for Apple App Store
      APP_STORE="ON"
	  ;;
    d)
      #-d is for DOCS
      DOCS="ON"
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      ;;
  esac
done

CMAKE_FLAGS="-DCMAKE_BUILD_TYPE=Release"
CPACK_FLAGS=""

QT_BASE_PATH="/opt/Qt5.1.0/5.1.0-beta1"

CMAKE=`which cmake`
QMAKE="${QT_BASE_PATH}/bin/qmake"

CC=`which clang`
if [ ! $CC ]; then
    CC=`which gcc`
    USE_LLVM=false
fi

CXX=`which clang++`
if [ ! $CXX ]; then
    CXX=`which g++`
    USE_LLVM=false
fi

if [ $APP_STORE == "ON" ]; then
    BUNDLE_ID="com.stitchworkssoftware.crochet-charts"
else
    BUNDLE_ID="com.stitchworkssoftware.CrochetCharts"
fi

export CC CXX

PLATFORM=`uname -s`
ARCH=`uname -m`

CMAKE_FLAGS="$CMAKE_FLAGS -DDOCS=$DOCS -DUSE_LLVM=$USE_LLVM"

mkdir -p ${PROJECT_DIR}/build
cd ${PROJECT_DIR}/build 
    
if [ $PLATFORM == "Darwin" ]; then

    MACOSX_DEPLOYMENT_TARGET=10.6
    MACOSX_SDK="/Developer/SDKs/MacOSX10.6.sdk/"
    QMAKE="/usr/local/Trolltech/Qt-4.8.4/bin/qmake"
    
    CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_OSX_ARCHITECTURES=i386;x86_64"
    CMAKE_FLAGS="$CMAKE_FLAGS -DQT_QMAKE_EXECUTABLE=$QMAKE"
    CMAKE_FLAGS="$CMAKE_FLAGS -DAPP_STORE=$APP_STORE"
    CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_OSX_DEPLOYMENT_TARGET=10.6"
    CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_OSX_SYSROOT=$MACOSX_SDK"
    CMAKE_FLAGS="$CMAKE_FLAGS -DBUNDLE_ID=$BUNDLE_ID"

elif [ $PLATFORM == "Linux" ]; then

    CMAKE_MODULE_PATH="${QT_BASE_PATH}/lib/cmake"
    QMAKE="${QT_BASE_PATH}/bin/qmake"
    CMAKE_PREFIX_PATH="${QT_BASE_PATH}" 

    if [ $ARCH == "i686" ]; then
      CMAKE_FLAGS="$CMAKE_FLAGS -DFORCE_32BIT=ON"
    fi

    export CMAKE_MODULE_PATH CMAKE_PREFIX_PATH
    CMAKE_FLAGS="$CMAKE_FLAGS -DQT_QMAKE_EXECUTABLE=\"$QMAKE\""
else
    echo "-- ERROR: unknown platform"
    exit 1
fi

display_vairiables

#if [ ! -x "`cmake ${PROJECT_DIR} ${CMAKE_FLAGS}`" ]; then
#    echo "cmake failed"
#   # exit 1
#fi
#
#if [ ! -x "`make`" ]; then
#    echo "build failed"
#    exit 1
#fi
#
#if [ ! -x "`cpack ${CPACK_FLAGS}`" ]; then
#    echo "packaging failed"
#    exit 1
#fi

cmake ${PROJECT_DIR} ${CMAKE_FLAGS}
make
cpack ${CPACK_FLAGS}
