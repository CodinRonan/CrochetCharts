#!/bin/bash
#
# This script builds a release version of
# the software for each supported platform.
#############################################

FLAG="-DAPP_STORE=OFF"
APP_STORE=0
BUNDLE_ID="com.stitchworkssoftware.Crochet Charts"

while getopts ":a" opt; do
  case $opt in
    a)
      echo "Apple Mac app store release"
      FLAG="-DAPP_STORE=ON"
      APP_STORE=1
      BUNDLE_ID="com.stitchworkssoftware.CrochetCharts"
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      ;;
  esac
done

PLATFORM=`uname -a | awk '{ print $1 }'`

if [ $PLATFORM == "Darwin" ]; then
    echo "================"
    echo "#"
    echo "# NOTE: Make sure that Java is installed or fop wont run and the docs wont install."
    echo "#"
    echo "================"

    export CC=/usr/bin/clang
    export CXX=/usr/bin/clang++

    mkdir -p ~/crochet/build
    cd ~/crochet/build

    MACOSX_DEPLOYMENT_TARGET=10.6
    
    #QMAKE=`which qmake`
    #Custom Qt build:
    QMAKE="/usr/local/Trolltech/Qt-4.8.4/bin/qmake"
    echo "-- Bundle_ID: $BUNDLE_ID"
    cmake ../ -DDOCS=ON -DQT_QMAKE_EXECUTABLE=$QMAKE -DCMAKE_BUILD_TYPE=Release $FLAG -DCMAKE_OSX_SYSROOT=/Developer/SDKs/MacOSX10.6.sdk/ -DCMAKE_OSX_DEPLOYMENT_TARGET=10.6 -DBUNDLE_ID="\"$BUNDLE_ID\""  && make
    
    cpack -G Bundle
    
    if [ $APP_STORE == 1 ]; then
        ../bin/sign_app -a -f _CPack_Packages/Darwin/Bundle/Crochet\ Charts-1.1.4
    fi

elif [ $PLATFORM == "Linux" ]; then

    ARCH=`uname -i`
    
    mkdir -p ~/crochet/build
    cd ~/crochet/build

    if [ $ARCH == "i386" ]; then
        cmake ../ -DDOCS=ON -DCMAKE_BUILD_TYPE=Release -DFORCE_32BIT=ON && make && cpack 
    else
        cmake .. -DDOCS=ON -DCMAKE_BUILD_TYPE=Release && make && cpack
    fi

else
    print "Warning unknown platform"
fi
